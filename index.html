<!DOCTYPE html>
<html lang="ru">
<head>

<link rel="icon" type="image/png" href="/my-favicon/./favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/my-favicon/./favicon.svg" />
<link rel="shortcut icon" href="/my-favicon/./favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/my-favicon/./apple-touch-icon.png" />
<link rel="manifest" href="/my-favicon/./site.webmanifest" />

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–§–∏–∑–∏–∫–∞ 9‚Äì11 –∫–ª–∞—Å—Å - —Ç—Ä–µ–Ω–∞–∂—ë—Ä</title>

<style>
  * { box-sizing: border-box; }

  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f0f4f7;
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    color: #fff;
    transition: background 0.5s ease;
  }

  h1 {
    margin-top: 20px;
    text-align: center;
    text-shadow: 2px 2px 5px rgba(0,0,0,0.7);
  }

  #levelDisplay {
    margin: 10px 0 10px 0;
    font-weight: 600;
    text-align: center;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
  }

  #expBarWrapper {
    width: 100%;
    max-width: 420px;
    height: 18px;
    background: rgba(255,255,255,0.25);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    margin-bottom: 15px;
  }

  #expBar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #00c6ff, #0072ff);
    transition: width 0.4s ease;
  }

  #menu {
    background: rgba(0, 70, 160, 0.85);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    padding: 20px;
    border-radius: 12px;
    max-width: 460px;
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 18px;
    color: #fff;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
  }

  label {
    font-size: 1rem;
    margin-bottom: 5px;
  }

  select, button {
    font-size: 1rem;
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    outline: none;
    cursor: pointer;
    width: 100%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: background-color 0.3s ease;
  }

  select:focus, button:hover {
    background-color: #1a50a0;
    color: #fff;
  }

  button {
    background-color: #2e7eea;
    font-weight: 700;
  }

  #tasks {
    margin-top: 30px;
    max-width: 850px;
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 25px;
  }

  .task {
    background: rgba(255, 255, 255, 0.95);
    padding: 18px 20px;
    border-radius: 14px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    color: #222;
    animation: fadeIn 0.5s ease forwards;
  }

  .task p {
    margin: 0 0 10px 0;
    font-size: 1.1rem;
    font-weight: 700;
  }

  .input-container {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .input-container label {
    font-weight: 600;
    white-space: nowrap;
  }

  input[type="number"] {
    flex-grow: 1;
    padding: 8px 12px;
    border: 1.8px solid #999;
    border-radius: 8px;
    outline: none;
    transition: border-color 0.3s ease;
    min-width: 150px;
  }

  input[type="number"]:focus {
    border-color: #2e7eea;
  }

  .unit {
    font-weight: 800;
    color: #1a2a47;
    background: #dcecff;
    padding: 5px 10px;
    border-radius: 8px;
  }

  .explanation {
    margin-top: 12px;
    background-color: #e4f0ff;
    padding: 10px 15px;
    border-radius: 10px;
    font-size: 0.95rem;
    line-height: 1.3;
    color: #1a2a47;
  }

  #buttonsWrapper {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 20px;
  }

  #checkAnswersButton, #backButton, #nextButton, #resetButton {
    padding: 12px 22px;
    font-size: 1.1rem;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background-color: #0a62d7;
    color: white;
    font-weight: 800;
    box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    transition: background-color 0.3s ease;
    min-width: 180px;
  }

  #checkAnswersButton:hover, #backButton:hover, #nextButton:hover, #resetButton:hover {
    background-color: #084a9f;
  }

  #resetButton {
    background-color: #e74c3c;
  }
  #resetButton:hover {
    background-color: #c0392b;
  }

  #results {
    max-width: 850px;
    width: 100%;
    margin-top: 25px;
    margin-bottom: 20px;
    font-weight: 600;
    font-size: 1.1rem;
    color: #222;
    background: rgba(255,255,255,0.92);
    border-radius: 12px;
    padding: 15px 18px;
    display: none;
  }

  .good { color: green; font-weight: 800; }
  .bad { color: red; font-weight: 800; }

  #levelUpMessage {
    max-width: 850px;
    width: 100%;
    background: rgba(0, 255, 120, 0.18);
    border: 2px solid rgba(0, 255, 120, 0.55);
    color: #fff;
    font-weight: 900;
    padding: 12px 15px;
    border-radius: 12px;
    text-align: center;
    display: none;
    margin-top: 10px;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
  }

  #statsBox {
    max-width: 850px;
    width: 100%;
    margin-top: 15px;
    background: rgba(0,0,0,0.35);
    border-radius: 12px;
    padding: 12px 15px;
    font-weight: 700;
    display: none;
  }

  #achievementsBox {
    max-width: 850px;
    width: 100%;
    margin-top: 12px;
    background: rgba(255,255,255,0.18);
    border-radius: 12px;
    padding: 12px 15px;
    font-weight: 800;
    display: none;
  }

  .achUnlocked {
    color: #00ff9d;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
  }

  #examModeInfo {
    max-width: 850px;
    width: 100%;
    background: rgba(255, 180, 0, 0.25);
    border: 2px solid rgba(255, 180, 0, 0.55);
    border-radius: 12px;
    padding: 12px 15px;
    font-weight: 900;
    margin-top: 12px;
    text-align: center;
    display: none;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 480px) {
    #menu { max-width: 100%; padding: 15px; }
    #tasks { max-width: 100%; }
    #checkAnswersButton, #backButton, #nextButton, #resetButton { min-width: 100%; }
    input[type="number"] { min-width: 100%; }
  }
</style>
</head>

<body>

<h1>–§–∏–∑–∏–∫–∞ 9‚Äì11 –∫–ª–∞—Å—Å - —Ç—Ä–µ–Ω–∞–∂—ë—Ä</h1>

<div id="levelDisplay">–£—Ä–æ–≤–µ–Ω—å: 1 | –û–ø—ã—Ç: 0 / 900</div>
<div id="expBarWrapper"><div id="expBar"></div></div>

<div id="levelUpMessage"></div>
<div id="examModeInfo"></div>

<div id="statsBox"></div>
<div id="achievementsBox"></div>

<div id="menu">
  <label for="topic">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:</label>
  <select id="topic">
    <option value="mechanics">–ú–µ—Ö–∞–Ω–∏–∫–∞</option>
    <option value="electricity">–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ</option>
    <option value="optics">–û–ø—Ç–∏–∫–∞</option>
    <option value="thermodynamics">–¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞</option>
    <option value="magnetism">–ú–∞–≥–Ω–µ—Ç–∏–∑–º</option>
    <option value="random">–°–ª—É—á–∞–π–Ω—ã–µ –∑–∞–¥–∞—á–∏</option>
  </select>

  <label for="difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å:</label>
  <select id="difficulty">
    <option value="easy">–õ—ë–≥–∫–∞—è</option>
    <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
    <option value="hard">–°–ª–æ–∂–Ω–∞—è</option>
    <option value="randomDiff">üé≤ –°–ª—É—á–∞–π–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å</option>
  </select>

  <label for="numTasks">–°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á —Ö–æ—Ç–∏—Ç–µ?</label>
  <select id="numTasks">
    <option value="1">1 –∑–∞–¥–∞—á–∞</option>
    <option value="2">2 –∑–∞–¥–∞—á–∏</option>
    <option value="3">3 –∑–∞–¥–∞—á–∏</option>
    <option value="4">4 –∑–∞–¥–∞—á–∏</option>
    <option value="5">5 –∑–∞–¥–∞—á</option>
  </select>

  <label for="mode">–†–µ–∂–∏–º:</label>
  <select id="mode">
    <option value="normal">–û–±—ã—á–Ω—ã–π</option>
    <option value="exam">–≠–∫–∑–∞–º–µ–Ω (10 –∑–∞–¥–∞—á)</option>
  </select>

  <button onclick="generateTasks()">–ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏</button>
  <button id="resetButton" onclick="resetProgress()">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
</div>

<div id="tasks"></div>

<div id="buttonsWrapper" style="display:none;">
  <button id="checkAnswersButton" onclick="checkAnswers()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
  <button id="nextButton" onclick="nextTasks()">NEXT</button>
  <button id="backButton" onclick="goBack()">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</button>
</div>

<div id="results"></div>

<script>
let currentTasks = [];
let examMode = false;

let experience = parseInt(localStorage.getItem("experience")) || 0;
let level = parseInt(localStorage.getItem("level")) || 1;

let stats = JSON.parse(localStorage.getItem("statsPhysics")) || {
  mechanics: { total: 0, correct: 0 },
  electricity: { total: 0, correct: 0 },
  optics: { total: 0, correct: 0 },
  thermodynamics: { total: 0, correct: 0 },
  magnetism: { total: 0, correct: 0 }
};

let achievements = JSON.parse(localStorage.getItem("achievementsPhysics")) || {
  streak5: false,
  streak10: false,
  streak20: false,
  level5: false,
  level10: false
};

let correctStreak = parseInt(localStorage.getItem("correctStreak")) || 0;

let lastSettings = JSON.parse(localStorage.getItem("lastSettings")) || {
  topic: "mechanics",
  difficulty: "easy",
  numTasks: "3",
  mode: "normal"
};

function expForNextLevel(lv) {
  return lv === 1 ? 900 : 900 + 400 * (lv - 1);
}

function updateLevelDisplay() {
  document.getElementById("levelDisplay").innerText =
    `–£—Ä–æ–≤–µ–Ω—å: ${level} | –û–ø—ã—Ç: ${experience} / ${expForNextLevel(level)}`;

  let percent = (experience / expForNextLevel(level)) * 100;
  if (percent > 100) percent = 100;
  if (percent < 0) percent = 0;

  document.getElementById("expBar").style.width = percent + "%";

  localStorage.setItem("experience", experience);
  localStorage.setItem("level", level);
}

document.body.style.backgroundImage =
  "linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)), url('https://images.unsplash.com/photo-1603964923133-fd8d03e6b63b?auto=format&fit=crop&w=1280&q=80')";

function setTaskBackground(topic) {
  let bgUrl = "";

  if (topic === "mechanics")
    bgUrl = "https://images.unsplash.com/photo-1581092795367-25cf35f1d2c1?auto=format&fit=crop&w=1280&q=80";
  else if (topic === "electricity")
    bgUrl = "https://images.unsplash.com/photo-1581092336120-88db16c6d8e3?auto=format&fit=crop&w=1280&q=80";
  else if (topic === "optics")
    bgUrl = "https://images.unsplash.com/photo-1579154203451-d1d5c24d45bc?auto=format&fit=crop&w=1280&q=80";
  else if (topic === "thermodynamics")
    bgUrl = "https://images.unsplash.com/photo-1526402460112-0d4e87d0e5e8?auto=format&fit=crop&w=1280&q=80";
  else if (topic === "magnetism")
    bgUrl = "https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&w=1280&q=80";
  else
    bgUrl = "https://images.unsplash.com/photo-1603964923133-fd8d03e6b63b?auto=format&fit=crop&w=1280&q=80";

  document.body.style.backgroundImage =
    `linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)), url(${bgUrl})`;
}

function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function roundSmart(x) {
  return Math.round(x * 1000) / 1000;
}

function getExpReward(difficulty) {
  if (difficulty === "easy") return 200;
  if (difficulty === "medium") return 350;
  return 550;
}

function getRandomDifficulty() {
  let r = Math.random();
  if (r < 0.4) return "easy";
  if (r < 0.75) return "medium";
  return "hard";
}

/* ===================== –ú–ï–•–ê–ù–ò–ö–ê ===================== */
function generateMechanicsTask(diff) {
  let taskText = "", answer = 0, unit = "", explanation = "";

  if (diff === "easy") {
    let v = randInt(3, 20);
    let t = randInt(2, 15);
    answer = v * t;
    unit = "–º";
    taskText = `–¢–µ–ª–æ –¥–≤–∏–∂–µ—Ç—Å—è —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é ${v} –º/—Å –≤ —Ç–µ—á–µ–Ω–∏–µ ${t} —Å. –ù–∞–π–¥–∏—Ç–µ –ø—É—Ç—å.`;
    explanation = `S = v √ó t = ${v} √ó ${t} = ${answer} –º.`;
  }
  else if (diff === "medium") {
    let a = randInt(1, 8);
    let t = randInt(2, 10);
    answer = 0.5 * a * t * t;
    unit = "–º";
    taskText = `–¢–µ–ª–æ –¥–≤–∏–∂–µ—Ç—Å—è —Ä–∞–≤–Ω–æ—É—Å–∫–æ—Ä–µ–Ω–Ω–æ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–∫–æ—è —Å —É—Å–∫–æ—Ä–µ–Ω–∏–µ–º ${a} –º/—Å¬≤ ${t} —Å–µ–∫—É–Ω–¥. –ù–∞–π–¥–∏—Ç–µ –ø—É—Ç—å.`;
    explanation = `S = (a √ó t¬≤)/2 = (${a} √ó ${t}¬≤)/2 = ${answer} –º.`;
  }
  else {
    let m = randInt(2, 15);
    let v = randInt(5, 25);
    answer = 0.5 * m * v * v;
    unit = "–î–∂";
    taskText = `–ú–∞—Å—Å–∞ —Ç–µ–ª–∞ ${m} –∫–≥, —Å–∫–æ—Ä–æ—Å—Ç—å ${v} –º/—Å. –ù–∞–π–¥–∏—Ç–µ –∫–∏–Ω–µ—Ç–∏—á–µ—Å–∫—É—é —ç–Ω–µ—Ä–≥–∏—é.`;
    explanation = `E–∫ = (m √ó v¬≤)/2 = (${m} √ó ${v}¬≤)/2 = ${answer} –î–∂.`;
  }

  return { taskText, answer: roundSmart(answer), unit, explanation };
}

/* ===================== –≠–õ–ï–ö–¢–†–ò–ß–ï–°–¢–í–û ===================== */
function generateElectricityTask(diff) {
  let taskText = "", answer = 0, unit = "", explanation = "";

  if (diff === "easy") {
    let I = randInt(1, 12);
    let R = randInt(1, 30);
    answer = I * R;
    unit = "–í";
    taskText = `–°–∏–ª–∞ —Ç–æ–∫–∞ ${I} –ê, —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ ${R} –û–º. –ù–∞–π–¥–∏—Ç–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ.`;
    explanation = `U = I √ó R = ${I} √ó ${R} = ${answer} –í.`;
  }
  else if (diff === "medium") {
    let U = randInt(20, 220);
    let R = randInt(5, 60);
    answer = U / R;
    unit = "–ê";
    taskText = `–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ ${U} –í, —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ ${R} –û–º. –ù–∞–π–¥–∏—Ç–µ —Å–∏–ª—É —Ç–æ–∫–∞.`;
    explanation = `I = U / R = ${U} / ${R} = ${roundSmart(answer)} –ê.`;
  }
  else {
    let U = randInt(50, 250);
    let I = randInt(1, 10);
    answer = U * I;
    unit = "–í—Ç";
    taskText = `–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ ${U} –í, —Å–∏–ª–∞ —Ç–æ–∫–∞ ${I} –ê. –ù–∞–π–¥–∏—Ç–µ –º–æ—â–Ω–æ—Å—Ç—å —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ç–æ–∫–∞.`;
    explanation = `P = U √ó I = ${U} √ó ${I} = ${answer} –í—Ç.`;
  }

  return { taskText, answer: roundSmart(answer), unit, explanation };
}

/* ===================== –û–ü–¢–ò–ö–ê ===================== */
function generateOpticsTask(diff) {
  let taskText = "", answer = 0, unit = "", explanation = "";

  if (diff === "easy") {
    let f = randInt(2, 20);
    answer = 1 / f;
    unit = "–¥–ø—Ç—Ä";
    taskText = `–§–æ–∫—É—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ª–∏–Ω–∑—ã ${f} –º. –ù–∞–π–¥–∏—Ç–µ –æ–ø—Ç–∏—á–µ—Å–∫—É—é —Å–∏–ª—É.`;
    explanation = `D = 1 / f = 1 / ${f} = ${roundSmart(answer)} –¥–ø—Ç—Ä.`;
  }
  else if (diff === "medium") {
    let f = randInt(5, 30);
    answer = f / 100;
    unit = "–º";
    taskText = `–§–æ–∫—É—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ª–∏–Ω–∑—ã ${f} —Å–º. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –≤ –º–µ—Ç—Ä—ã.`;
    explanation = `${f} —Å–º = ${f} / 100 = ${answer} –º.`;
  }
  else {
    let d = randInt(2, 15);
    answer = 1 / d;
    unit = "–º";
    taskText = `–û–ø—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–ª–∞ –ª–∏–Ω–∑—ã ${d} –¥–ø—Ç—Ä. –ù–∞–π–¥–∏—Ç–µ —Ñ–æ–∫—É—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ.`;
    explanation = `f = 1 / D = 1 / ${d} = ${roundSmart(answer)} –º.`;
  }

  return { taskText, answer: roundSmart(answer), unit, explanation };
}

/* ===================== –¢–ï–†–ú–û–î–ò–ù–ê–ú–ò–ö–ê ===================== */
function generateThermoTask(diff) {
  let taskText = "", answer = 0, unit = "", explanation = "";

  if (diff === "easy") {
    let c = 4200;
    let m = randInt(1, 5);
    let dt = randInt(10, 50);
    answer = c * m * dt;
    unit = "–î–∂";
    taskText = `–ù–∞–≥—Ä–µ–≤–∞—é—Ç –≤–æ–¥—É –º–∞—Å—Å–æ–π ${m} –∫–≥ –Ω–∞ ${dt}¬∞C. (c = 4200 –î–∂/(–∫–≥¬∑¬∞C)). –ù–∞–π–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–ø–ª–æ—Ç—ã.`;
    explanation = `Q = c √ó m √ó ŒîT = 4200 √ó ${m} √ó ${dt} = ${answer} –î–∂.`;
  }
  else if (diff === "medium") {
    let L = 330000;
    let m = randInt(1, 5);
    answer = L * m;
    unit = "–î–∂";
    taskText = `–õ—ë–¥ –º–∞—Å—Å–æ–π ${m} –∫–≥ –ø–ª–∞–≤–∏—Ç—Å—è. –£–¥–µ–ª—å–Ω–∞—è —Ç–µ–ø–ª–æ—Ç–∞ –ø–ª–∞–≤–ª–µ–Ω–∏—è –ª—å–¥–∞ Œª = 330000 –î–∂/–∫–≥. –ù–∞–π–¥–∏—Ç–µ Q.`;
    explanation = `Q = Œª √ó m = 330000 √ó ${m} = ${answer} –î–∂.`;
  }
  else {
    let Q = randInt(4000, 12000);
    let A = randInt(500, Q - 500);
    answer = (A / Q) * 100;
    unit = "%";
    taskText = `–¢–µ–ø–ª–æ–≤–∞—è –º–∞—à–∏–Ω–∞ –ø–æ–ª—É—á–∏–ª–∞ ${Q} –î–∂ —Ç–µ–ø–ª–æ—Ç—ã –∏ —Å–æ–≤–µ—Ä—à–∏–ª–∞ —Ä–∞–±–æ—Ç—É ${A} –î–∂. –ù–∞–π–¥–∏—Ç–µ –ö–ü–î.`;
    explanation = `Œ∑ = A/Q √ó 100% = ${A}/${Q} √ó 100% = ${roundSmart(answer)}%.`;
  }

  return { taskText, answer: roundSmart(answer), unit, explanation };
}

/* ===================== –ú–ê–ì–ù–ï–¢–ò–ó–ú ===================== */
function generateMagnetismTask(diff) {
  let taskText = "", answer = 0, unit = "", explanation = "";

  if (diff === "easy") {
    let B = randInt(1, 8);
    let I = randInt(1, 10);
    let l = randInt(1, 6);
    answer = B * I * l;
    unit = "–ù";
    taskText = `–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ –¥–ª–∏–Ω–æ–π ${l} –º —Å —Ç–æ–∫–æ–º ${I} –ê –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –º–∞–≥–Ω–∏—Ç–Ω–æ–º –ø–æ–ª–µ B = ${B} –¢–ª (—É–≥–æ–ª 90¬∞). –ù–∞–π–¥–∏—Ç–µ —Å–∏–ª—É –ê–º–ø–µ—Ä–∞.`;
    explanation = `F = B √ó I √ó l = ${B} √ó ${I} √ó ${l} = ${answer} –ù.`;
  }
  else if (diff === "medium") {
    let q = 0.002;
    let v = randInt(2, 10);
    let B = randInt(1, 6);
    answer = q * v * B;
    unit = "–ù";
    taskText = `–ó–∞—Ä—è–¥ q = ${q} –ö–ª –¥–≤–∏–∂–µ—Ç—Å—è —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é ${v} –º/—Å –≤ –º–∞–≥–Ω–∏—Ç–Ω–æ–º –ø–æ–ª–µ B = ${B} –¢–ª (—É–≥–æ–ª 90¬∞). –ù–∞–π–¥–∏—Ç–µ —Å–∏–ª—É –õ–æ—Ä–µ–Ω—Ü–∞.`;
    explanation = `F = q √ó v √ó B = ${q} √ó ${v} √ó ${B} = ${roundSmart(answer)} –ù.`;
  }
  else {
    let F = randInt(10, 100);
    let I = randInt(1, 10);
    let l = randInt(1, 10);
    answer = F / (I * l);
    unit = "–¢–ª";
    taskText = `–ù–∞ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Å–∏–ª–∞ ${F} –ù. –¢–æ–∫ ${I} –ê, –¥–ª–∏–Ω–∞ ${l} –º (—É–≥–æ–ª 90¬∞). –ù–∞–π–¥–∏—Ç–µ –º–∞–≥–Ω–∏—Ç–Ω—É—é –∏–Ω–¥—É–∫—Ü–∏—é B.`;
    explanation = `F = B √ó I √ó l ‚Üí B = F/(I√ól) = ${F}/(${I}√ó${l}) = ${roundSmart(answer)} –¢–ª.`;
  }

  return { taskText, answer: roundSmart(answer), unit, explanation };
}

/* ===================== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===================== */
function updateStatsBox() {
  const box = document.getElementById("statsBox");
  box.style.display = "block";

  function line(name, obj) {
    return `${name}: ${obj.correct} / ${obj.total}`;
  }

  box.innerHTML = `
    üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b><br>
    ${line("–ú–µ—Ö–∞–Ω–∏–∫–∞", stats.mechanics)}<br>
    ${line("–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ", stats.electricity)}<br>
    ${line("–û–ø—Ç–∏–∫–∞", stats.optics)}<br>
    ${line("–¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞", stats.thermodynamics)}<br>
    ${line("–ú–∞–≥–Ω–µ—Ç–∏–∑–º", stats.magnetism)}<br>
    <hr>
    üî• –°–µ—Ä–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥: <b>${correctStreak}</b>
  `;
}

function saveStats() {
  localStorage.setItem("statsPhysics", JSON.stringify(stats));
  localStorage.setItem("correctStreak", correctStreak);
}

/* ===================== –î–û–°–¢–ò–ñ–ï–ù–ò–Ø ===================== */
function checkAchievements() {
  let unlocked = [];

  if (!achievements.streak5 && correctStreak >= 5) {
    achievements.streak5 = true;
    unlocked.push("üèÜ –°–µ—Ä–∏—è 5 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥!");
  }

  if (!achievements.streak10 && correctStreak >= 10) {
    achievements.streak10 = true;
    unlocked.push("üèÜ –°–µ—Ä–∏—è 10 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥!");
  }

  if (!achievements.streak20 && correctStreak >= 20) {
    achievements.streak20 = true;
    unlocked.push("üèÜ –°–µ—Ä–∏—è 20 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥!");
  }

  if (!achievements.level5 && level >= 5) {
    achievements.level5 = true;
    unlocked.push("‚≠ê –î–æ—Å—Ç–∏–≥–Ω—É—Ç 5 —É—Ä–æ–≤–µ–Ω—å!");
  }

  if (!achievements.level10 && level >= 10) {
    achievements.level10 = true;
    unlocked.push("üåü –î–æ—Å—Ç–∏–≥–Ω—É—Ç 10 —É—Ä–æ–≤–µ–Ω—å!");
  }

  localStorage.setItem("achievementsPhysics", JSON.stringify(achievements));

  const box = document.getElementById("achievementsBox");

  if (unlocked.length > 0) {
    box.style.display = "block";
    box.innerHTML = `<span class="achUnlocked">${unlocked.join("<br>")}</span>`;
  }
}

/* ===================== –ì–ï–ù–ï–†–ê–¶–ò–Ø ===================== */
function generateTasks() {
  const topic = document.getElementById("topic").value;
  const numTasksSelected = parseInt(document.getElementById("numTasks").value);
  const difficulty = document.getElementById("difficulty").value;
  const mode = document.getElementById("mode").value;

  examMode = (mode === "exam");

  let numTasks = examMode ? 10 : numTasksSelected;

  lastSettings = {
    topic: topic,
    difficulty: difficulty,
    numTasks: numTasksSelected.toString(),
    mode: mode
  };
  localStorage.setItem("lastSettings", JSON.stringify(lastSettings));

  const tasksDiv = document.getElementById("tasks");
  tasksDiv.innerHTML = "";
  currentTasks = [];

  document.getElementById("menu").style.display = "none";
  document.getElementById("buttonsWrapper").style.display = "flex";
  document.getElementById("results").style.display = "none";
  document.getElementById("results").innerHTML = "";
  document.getElementById("levelUpMessage").style.display = "none";
  document.getElementById("achievementsBox").style.display = "none";

  document.getElementById("examModeInfo").style.display = examMode ? "block" : "none";
  document.getElementById("examModeInfo").innerHTML = examMode ? "‚ö†Ô∏è –≠–∫–∑–∞–º–µ–Ω: 10 –∑–∞–¥–∞—á. –û–±—ä—è—Å–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏." : "";

  setTaskBackground(topic);
  updateStatsBox();

  for (let i = 0; i < numTasks; i++) {
    let taskObj;
    let usedDifficulty = difficulty;

    if (difficulty === "randomDiff") {
      usedDifficulty = getRandomDifficulty();
    }

    if (topic === "mechanics") taskObj = generateMechanicsTask(usedDifficulty);
    else if (topic === "electricity") taskObj = generateElectricityTask(usedDifficulty);
    else if (topic === "optics") taskObj = generateOpticsTask(usedDifficulty);
    else if (topic === "thermodynamics") taskObj = generateThermoTask(usedDifficulty);
    else if (topic === "magnetism") taskObj = generateMagnetismTask(usedDifficulty);
    else {
      let r = Math.random();
      if (r < 0.2) taskObj = generateMechanicsTask(usedDifficulty);
      else if (r < 0.4) taskObj = generateElectricityTask(usedDifficulty);
      else if (r < 0.6) taskObj = generateOpticsTask(usedDifficulty);
      else if (r < 0.8) taskObj = generateThermoTask(usedDifficulty);
      else taskObj = generateMagnetismTask(usedDifficulty);
    }

    currentTasks.push({
      task: taskObj.taskText,
      answer: taskObj.answer,
      explanation: taskObj.explanation,
      unit: taskObj.unit,
      isSolved: false,
      difficulty: usedDifficulty,
      topic: topic
    });

    const taskDiv = document.createElement("div");
    taskDiv.className = "task";
    taskDiv.style.animationDelay = `${i * 0.12}s`;

    taskDiv.innerHTML = `
      <p>${taskObj.taskText}</p>
      <div class="input-container">
        <label for="answer${i}">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
        <input type="number" id="answer${i}" step="any" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç" />
        <span class="unit">${taskObj.unit}</span>
      </div>
      <div class="explanation" id="explanation${i}" style="display:none;"></div>
    `;

    tasksDiv.appendChild(taskDiv);
  }

  setTimeout(() => {
    let firstInput = document.getElementById("answer0");
    if (firstInput) firstInput.focus();
  }, 200);
}

/* ===================== NEXT ===================== */
function nextTasks() {
  document.getElementById("topic").value = lastSettings.topic;
  document.getElementById("difficulty").value = lastSettings.difficulty;
  document.getElementById("numTasks").value = lastSettings.numTasks;
  document.getElementById("mode").value = lastSettings.mode;
  generateTasks();
}

/* ===================== –ü–†–û–í–ï–†–ö–ê ===================== */
function checkAnswers() {
  const resultsDiv = document.getElementById("results");
  resultsDiv.style.display = "block";
  resultsDiv.innerHTML = "";

  let gainedExp = 0;
  let correctCount = 0;

  for (let i = 0; i < currentTasks.length; i++) {
    const task = currentTasks[i];
    const input = document.getElementById(`answer${i}`);
    const explanationDiv = document.getElementById(`explanation${i}`);

    const userAnswerRaw = input.value.trim();

    explanationDiv.style.display = "none";
    explanationDiv.innerHTML = "";

    if (userAnswerRaw === "") {
      resultsDiv.innerHTML += `<div>–ó–∞–¥–∞—á–∞ ${i + 1}: –û—Ç–≤–µ—Ç –Ω–µ –≤–≤–µ–¥—ë–Ω.</div>`;
      continue;
    }

    const userAnswer = parseFloat(userAnswerRaw);

    if (isNaN(userAnswer)) {
      resultsDiv.innerHTML += `<div>–ó–∞–¥–∞—á–∞ ${i + 1}: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç.</div>`;
      continue;
    }

    let tolerance = 0.02;
    if (task.unit === "–î–∂" || task.unit === "–ù" || task.unit === "–í—Ç") tolerance = 0.1;

    if (Math.abs(userAnswer - task.answer) <= tolerance) {
      resultsDiv.innerHTML += `<div class="good">–ó–∞–¥–∞—á–∞ ${i + 1}: –í–µ—Ä–Ω–æ ‚úÖ</div>`;
      correctCount++;

      if (!task.isSolved) {
        gainedExp += getExpReward(task.difficulty);
        task.isSolved = true;
      }
    } else {
      resultsDiv.innerHTML += `<div class="bad">–ó–∞–¥–∞—á–∞ ${i + 1}: –ù–µ–≤–µ—Ä–Ω–æ ‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${task.answer} ${task.unit}</div>`;
    }

    if (!examMode) {
      explanationDiv.style.display = "block";
      explanationDiv.innerHTML = `<strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</strong><br>${task.explanation}`;
    }
  }

  if (examMode) {
    resultsDiv.innerHTML += `<hr><b>–≠–∫–∑–∞–º–µ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω!</b><br>`;
  }

  resultsDiv.innerHTML += `<hr><div>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <b>${correctCount}</b> –∏–∑ <b>${currentTasks.length}</b></div>`;

  // –û—Ü–µ–Ω–∫–∞ –¥–ª—è —ç–∫–∑–∞–º–µ–Ω–∞
  if (examMode) {
    let percent = (correctCount / currentTasks.length) * 100;
    let grade = "2";

    if (percent >= 90) grade = "5";
    else if (percent >= 70) grade = "4";
    else if (percent >= 50) grade = "3";

    resultsDiv.innerHTML += `<div style="margin-top:10px;"><b>–û—Ü–µ–Ω–∫–∞:</b> ${grade} (${roundSmart(percent)}%)</div>`;

    resultsDiv.innerHTML += `<hr><b>–û–±—ä—è—Å–Ω–µ–Ω–∏—è:</b><br>`;
    for (let i = 0; i < currentTasks.length; i++) {
      let expDiv = document.getElementById(`explanation${i}`);
      expDiv.style.display = "block";
      expDiv.innerHTML = `<strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</strong><br>${currentTasks[i].explanation}`;
    }
  }

  let chosenTopic = lastSettings.topic;

  if (chosenTopic !== "random") {
    stats[chosenTopic].total += currentTasks.length;
    stats[chosenTopic].correct += correctCount;
  }

  if (correctCount === currentTasks.length) {
    correctStreak++;
  } else {
    correctStreak = 0;
  }

  saveStats();
  updateStatsBox();

  if (gainedExp > 0) {
    experience += gainedExp;

    let levelUps = 0;
    while (experience >= expForNextLevel(level)) {
      experience -= expForNextLevel(level);
      level++;
      levelUps++;
    }

    updateLevelDisplay();

    if (levelUps > 0) {
      const msg = document.getElementById("levelUpMessage");
      msg.style.display = "block";
      msg.innerHTML = `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–≤—ã—Å–∏–ª–∏ —É—Ä–æ–≤–µ–Ω—å –¥–æ <b>${level}</b>! (+${levelUps} —É—Ä–æ–≤–µ–Ω—å)`;
    }
  }

  checkAchievements();
}

/* ===================== –°–ë–†–û–° ===================== */
function resetProgress() {
  if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ü—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—ë–Ω!")) return;

  localStorage.removeItem("experience");
  localStorage.removeItem("level");
  localStorage.removeItem("statsPhysics");
  localStorage.removeItem("achievementsPhysics");
  localStorage.removeItem("correctStreak");
  localStorage.removeItem("lastSettings");

  alert("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω!");
  location.reload();
}

/* ===================== –ù–ê–ó–ê–î ===================== */
function goBack() {
  document.getElementById("menu").style.display = "flex";
  document.getElementById("tasks").innerHTML = "";
  document.getElementById("buttonsWrapper").style.display = "none";
  document.getElementById("results").innerHTML = "";
  document.getElementById("results").style.display = "none";
  document.getElementById("levelUpMessage").style.display = "none";
  document.getElementById("statsBox").style.display = "none";
  document.getElementById("achievementsBox").style.display = "none";
  document.getElementById("examModeInfo").style.display = "none";

  examMode = false;

  document.body.style.backgroundImage =
    "linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)), url('https://images.unsplash.com/photo-1603964923133-fd8d03e6b63b?auto=format&fit=crop&w=1280&q=80')";
}

/* ===================== ENTER ===================== */
document.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && document.getElementById("buttonsWrapper").style.display === "flex") {
    checkAnswers();
  }
});

/* ===================== –ó–ê–ì–†–£–ó–ö–ê –ù–ê–°–¢–†–û–ï–ö ===================== */
document.getElementById("topic").value = lastSettings.topic;
document.getElementById("difficulty").value = lastSettings.difficulty;
document.getElementById("numTasks").value = lastSettings.numTasks;
document.getElementById("mode").value = lastSettings.mode;

updateLevelDisplay();
</script>

</body>
</html>
